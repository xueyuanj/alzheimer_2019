---
title: "trem2.apoe"
output: html_document
---

```{r }

library(dplyr)
library(ggplot2)
library(Matrix)
library(Seurat)

# /anaconda2/bin/R
# /opt/R/3.6.1/bin/R

setwd("/public_genomic_data_downloads/czhang/sharon/")

clinical_infor = read.csv("supplement_3.csv")
idmap = read.csv("id_mapping.csv")
uniqidmap = unique(idmap[,c("projid", "Subject")])

# table with both subject and project id
mergeid = merge(clinical_infor, uniqidmap, by = "Subject")

cell_trait = readRDS("microglia.subcluster.trait.rds")

trem2geno = read.csv("rosmap.trem2.genotype.csv")
trem2geno[,"total_mut"] = rowSums(trem2geno[,2:ncol(trem2geno)])
table(trem2geno$total_mut)

# 0     1     2
# 1108  41    3

# rare indeed

# check how many individuals in the dataset have mutation 
checktrem2 = merge(mergeid, trem2geno, by = "projid")
table(checktrem2$total_mut)

# 0    1
# 35   3

# further analysis on Trem2 will be performed on the 38 dataset
# cell_trait = readRDS("microglia.subcluster.trait.rds")

# subset the 38 individuals

trem2indiv = filter(cell_trait, projid%in%checktrem2$projid )
# 1457 cells left
trem2test = merge(trem2indiv, trem2geno, by = "projid") 

trem2input = table(trem2test[, c("cluster", "total_mut")])

streamlinetest = function(x){
  testtable = as.matrix(x)
  #print(testtable)
  ncluster = nrow(testtable); ntrait = ncol(testtable)
  pmatrix = as.data.frame(as.matrix(NA, ncol = ntrait, nrow=ncluster))
  for (i in 1:ncluster) {
    for (j in 1:ntrait) {
      fishertable = as.data.frame(as.matrix(NA, ncol=2, nrow=2))
      fishertable[1,1] = testtable[i, j]
      fishertable[1,2] = rowSums(as.matrix(testtable[,-j]))[i]
      fishertable[2,1] = colSums(as.matrix(testtable[-i,]))[j]
      fishertable[2,2] = sum(testtable[-i,-j])
      #print(fishertable)
      testresult = fisher.test(fishertable)
      pvalue = testresult$p.value
      #print(testresult$estimate)
      pmatrix[i,j] = pvalue
    }
  }
  fdr = apply(pmatrix, 2, function(x){
    p.adjust(x, method = "bonferroni", n=4)
  })
  colnames(fdr) = colnames(testtable)
  rownames(fdr) = rownames(testtable)
  print(fdr)
}

streamlinechisq = function(x){
  testtable = as.matrix(x)
  print(chisq.test(testtable)$expected)
  rawp = apply(testtable, 1, function(x) chisq.test(x,p=colSums(testtable)/sum(testtable), simulate.p.value = TRUE, B=10000)$p.value)
  
  fdr = sapply(rawp,  function(x){
    p.adjust(x, method = "bonferroni", n=4)
  })
  print(fdr)
}


# 3) Apoe genotype
apoetable = table(cell_trait[, c("cluster", "apoe_genotype")])

# 4 and no 4
fourornot = matrix(NA, nrow = 4, ncol = 2)
fourornot[,1] = rowSums(apoetable[,1:2]);fourornot[,2] = rowSums(apoetable[,3:4])

colnames(fourornot) = c("no4", "4"); rownames(fourornot) =c("0", "1", "2", "3")



# no 4, one 4 and two 4
noffour =  matrix(NA, nrow = 4, ncol = 3)
noffour[, 1] = rowSums(apoetable[,1:2]); noffour[,c(2,3)] = apoetable[,3:4]

colnames(noffour) = c("no4", "one4", "two4"); rownames(noffour) =c("0", "1", "2", "3")


print(trem2input)
streamlinechisq(trem2input)
streamlinetest(trem2input)

print(fourornot)
streamlinechisq(fourornot)
streamlinetest(fourornot)

print(noffour)
streamlinechisq(noffour)
streamlinetest(noffour)
# sink()


# repeat the test with subcluster information from the paper
paper_tsne = read.delim("filtered_column_metadata.txt")
paper_mic_sub = dplyr::filter(paper_tsne, broad.cell.type == "Mic")

# trem2 part
paper_trem2_subc = merge(paper_mic_sub, trem2geno, by="projid")
paper_trem2_input = table(paper_trem2_subc[, c("Subcluster", "total_mut")])[c("Mic0", "Mic1", "Mic2", "Mic3"),]
print(paper_trem2_input)
streamlinechisq(paper_trem2_input)
streamlinetest(paper_trem2_input)

# apoe part
paper_apoe_subc = merge(paper_mic_sub, cell_trait, by="TAG")
paper_apoetable = table(paper_apoe_subc[, c("Subcluster", "apoe_genotype")])[c("Mic0", "Mic1", "Mic2", "Mic3"),]

# 4 and no 4
p_fourornot = matrix(NA, nrow = 4, ncol = 2)
p_fourornot[,1] = rowSums(paper_apoetable[,1:2]);p_fourornot[,2] = rowSums(paper_apoetable[,3:4])

colnames(p_fourornot) = c("no4", "4"); rownames(p_fourornot) =c("0", "1", "2", "3")

# no 4, one 4 and two 4
p_noffour =  matrix(NA, nrow = 4, ncol = 3)
p_noffour[, 1] = rowSums(paper_apoetable[,1:2]); p_noffour[,c(2,3)] = paper_apoetable[,3:4]

colnames(p_noffour) = c("no4", "one4", "two4"); rownames(p_noffour) =c("0", "1", "2", "3")


print(p_fourornot)
streamlinechisq(p_fourornot)
streamlinetest(p_fourornot)

print(p_noffour)
streamlinechisq(p_noffour)
streamlinetest(p_noffour)




```
